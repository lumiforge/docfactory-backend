# Архитектура бэкенда для SaaS сервиса генерации гарантийных талонов и инструкций

***

## Общие принципы

- **Язык и платформа:** Golang на Yandex Cloud Functions (serverless)
- **База данных:** Yandex YDB с поддержкой multi-tenant (tenant_id для изоляции данных)
- **Хранение файлов:** Yandex Object Storage (S3-совместимое)
- **API:** REST API с OpenAPI-спецификацией для фронтенда и внешних интеграций
- **Аутентификация/авторизация:** JWT + интеграция с Yandex IAM
- **Масштабируемость:** горизонтальное масштабирование с автоматическим балансировщиком нагрузки
- **Мониторинг/логирование:** Yandex Monitoring и OpenTelemetry

***

## Компоненты архитектуры

### 1. API Gateway (Yandex API Gateway)

- Единая точка входа для всех клиентских запросов
- Поддержка аутентификации (JWT) и авторизации
- Роутинг на соответствующие Cloud Functions
- Rate limiting и throttle для защиты от abuse

### 2. Cloud Functions

Микросервисный подход с функциями по зонам ответственности:

| Функция                      | Зона ответственности                                    |
|-----------------------------|---------------------------------------------------------|
| **Auth Service**             | Регистрация, вход, выход, refresh токенов, валидация    |
| **Template Service**         | CRUD шаблонов, версионирование, дублирование            |
| **Versioning Service**       | Управление версиями шаблонов, сравнение, откаты         |
| **Document Generation Service** | Генерация PDF, DOCX, HTML, QR-кодов на шаблонах       |
| **Asset Management Service** | Загрузка, хранение и удаление логотипов и изображений   |
| **Bulk Operations Service**  | Обработка массовых операций над шаблонами                |
| **Import/Export Service**    | Импорт и экспорт шаблонов (JSON, ZIP)                    |
| **Notification Service**     | Уведомления пользователей по email/webhook               |

### 3. База данных YDB (distributed SQL)

- Таблицы с tenant_id для изоляции
- Основные таблицы:

| Таблица       | Описание                                  |
|---------------|-------------------------------------------|
| tenants       | Информация о клиенте                       |
| users         | Пользователи с ролями                      |
| templates     | Шаблоны с метаданными                      |
| template_versions | История версий шаблонов                  |
| documents     | Сгенерированные документы                  |
| assets        | Логотипы, изображения, watermarks          |
| audit_logs    | Аудит операций                             |

- Пагинация реализуется на уровне запросов с offset и limit

### 4. Объектное хранилище (Yandex Object Storage)

- Хранение:
  - JSON-схем шаблонов
  - Сгенерированных PDF, DOCX, HTML файлов
  - Превью (thumbnail)
  - Загрузок ассетов (логотипы, изображения)

- Структура бакета:
```
bucket-name/
├── tenants/
│   ├── tenant-001/
│   │   ├── templates/
│   │   ├── documents/
│   │   └── assets/
│   └── tenant-002/
│       └── ...
```

***

## Взаимодействие компонентов

### Запросы клиента (Frontend)

1. Клиент обращается в **API Gateway**
2. Gateway перенаправляет запрос в соответствующую Cloud Function
3. Cloud Function:
   - Аутентифицирует запрос (извлекает tenant_id, user_id)
   - Выполняет бизнес-логику:
     - Челает запросы к YDB
     - Обрабатывает файлы в Object Storage
     - Отвечает или отсылает задачи в очередь для долгих операций
4. Возвращает результат или ошибку клиенту

***

## Распределение бизнес-логики

### Аутентификация и авторизация

- Авторизация через JWT с access и refresh токенами (refresh — httpOnly куки)
- Роли пользователей: owner, admin, editor, viewer
- Проверка прав на функции (RBAC) на уровне Cloud Functions и запросов к базе

### Управление шаблонами

- CRUD операции (create, read, update, soft/delete, restore)
- Версионирование: создание новых версий при изменении, просмотр истории, сравнение версий
- Дублирование шаблонов с копированием логотипов и JSON-схем
- Хранение JSON-схем в Object Storage

### Генерация документов

- Асинхронная задача на генерацию PDF/DOCX/HTML документов
- Поддержка QR и штрих-кодов интегрирована
- Загрузка результата и превью в Object Storage
- Хранение ссылок в YDB

### Bulk операции и импорт-экспорт

- Массовые операции (delete, duplicate, export ZIP)
- Импорт JSON с валидацией и стратегиями разрешения конфликтов
- Асинхронная обработка с возвращением отчетов и ошибок
- Управление ассетами (загрузка, удаление)

***

## Вспомогательные компоненты

### Очередь заданий (по необходимости)

- Для длительных операций (bulk, генерация) используется очередь (например, Yandex Message Queue + Cloud Functions)
- Обработка на worker-функциях с повтором при ошибках

### Мониторинг и телеаметрика

- Метрики Cloud Functions (исполнение, ошибки)
- Логи запросов и ошибок с tenant_id в Yandex Logging
- Настройка алертов (падение функции, превышение лимитов)

***

## Безопасность

- Использование TLS, шифрование данных в покое (YDB, Object Storage)
- JWT токены с ограниченным сроком
- Multi-tenant изоляция на уровне запросов и хранилищ
- Мониторинг и аудит доступа к данным

***

## Диаграмма (логический уровень)

```
+------------------+       +-------------------+       +-------------------------------+
|   API Gateway    |-----> | Cloud Functions   |-----> | Yandex YDB (multi-tenant SQL)  |
+------------------+       +-------------------+       +-------------------------------+
                                    |
                                    |
                                    v
                       +----------------------------+
                       | Yandex Object Storage (S3) |
                       +----------------------------+
```

***

Этот план архитектуры обеспечит гибкость, масштабируемость и безопасность при реализации устойчивого и удобного SaaS сервиса генерации документов.